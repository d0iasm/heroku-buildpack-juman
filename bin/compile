#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

indent() {
  sed -u 's/^/       /'
}

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

JUMAN_URL="http://nlp.ist.i.kyoto-u.ac.jp/nl-resource/juman/juman-7.01.tar.bz2"
KNP_URL="http://nlp.ist.i.kyoto-u.ac.jp/nl-resource/knp/knp-4.18.tar.bz2"

echo "-----> Install juman"
echo "JUMAN_URL = " $JUMAN_URL | indent

wget -P $CACHE_DIR -q $JUMAN_URL
tar jxvf $CACHE_DIR/juman-7.01.tar.bz2 -C $CACHE_DIR

mkdir -p "$BUILD_DIR/bin/juman"
cd $CACHE_DIR/juman-7.01
./configure --prefix="$BUILD_DIR/bin/juman"
make
make install

PROFILE_PATH="$BUILD_DIR/.profile.d/pyknp.sh"
mkdir -p $(dirname $PROFILE_PATH)
echo 'export PATH="$PATH:$BUILD_DIR/bin/juman/bin"' >> $PROFILE_PATH
. $PROFILE_PATH
ls -al $BUILD_DIR
ls -al $BUILD_DIR/bin/juman
ls -al $BUILD_DIR/.profile.d
echo "$PATH"

echo "-----> JUMAN version: "
juman -v | indent


echo "-----> Install knp"
echo "KNP_URL = " $KNP_URL | indent
wget -P $CACHE_DIR -q $KNP_URL
tar jxvf $CACHE_DIR/knp-4.18.tar.bz2 -C $CACHE_DIR

mkdir -p "$BUILD_DIR/bin/knp"
cd $CACHE_DIR/knp-4.18
./configure --prefix="$BUILD_DIR/bin/knp" --with-juman-prefix="$BUILD_DIR/bin/juman"
make
make install

echo 'export PATH="$PATH:$BUILD_DIR/bin/knp/bin"' >> $PROFILE_PATH
. $PROFILE_PATH

echo "-----> KNP version: "
knp -v | indent
